'use strict'

const delay = ms => new Promise(res => setTimeout(res, ms))

const mysql = require('../index')({
  //manageConns: true,
  cap      : 50,
  connUtilization : 0.9,
  config: {
    host     : 'localhost',
    database : 'test-mysql',
    user     : 'test',
    password : 'test',
    port     : '8889'
  },
  onConnect: (client) => { console.log('MYSQL Connected:', client.threadId) },
  onClose: () => { console.log('MYSQL Connection Closed') },
  onError: (e) => { console.log('MYSQL Connection Error:',e.message) },
  onRetry: (e,retries,sleep) => { console.log('RETRY',retries,sleep) },
  onKill: (zombie) => { console.log('Kill:',zombie) },
  onKillError: (e) => { console.log('Kill Error:',e.message) }
})

// console.log(mysql);

// mysql.config({
//   host     : 'localhost',
//   database : 'test-mysql',
//   user     : 'test',
//   password : 'test',
//   port     : '8889'
// })

console.log('MYSQL TESTING:');

const handler = async () => {

  try {

    // await mysql.connect()

    // let maxConns = await mysql.getMaxConnections()
    // console.log('Max Connections:',maxConns);
    // let totalConns = await mysql.getTotalConnections(maxConns.user)
    // console.log('Total Connections:',totalConns);
    //
    // // let processList = await mysql.query('SELECT * FROM information_schema.processlist WHERE command = "Sleep" AND time > 10 ORDER BY id')
    // // console.log(processList);
    // // processList.results.forEach(row => {
    // //   //mysql.query('CALL mysql.rds_kill(?)',[row.id])
    // //   mysql.query('KILL ?',[row.ID])
    // // })
    // await mysql.quit()
    //
    // console.log('\n\n----- THIS IS POST QUIT ------\n\n');
    //
    // await mysql.connect()

    let results1 = await mysql.query('SELECT * FROM test LIMIT 0,1')
    console.log(results1);
  } catch (e) {
    console.log('ERROR CAUGHT:',e.message);
  }

  await mysql.end()
}

handler()
